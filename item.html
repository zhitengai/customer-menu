<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Menu Management System</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f7fa;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 30px;
      font-weight: 600;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 25px;
      justify-content: center;
      max-width: 1400px;
      margin: 0 auto;
    }
    .form-container, .menu-container {
      flex: 1;
      min-width: 400px;
      background-color: #fff;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 30px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      font-weight: 600;
      display: block;
      margin-bottom: 8px;
      color: #2c3e50;
    }
    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 12px;
      margin-top: 5px;
      border-radius: 6px;
      border: 1px solid #ddd;
      font-size: 15px;
      transition: border-color 0.3s;
    }
    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus,
    textarea:focus {
      border-color: #3498db;
      outline: none;
      box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
    }
    input[type="file"] {
      margin-top: 10px;
      width: 100%;
      padding: 12px;
      border: 2px dashed #ddd;
      border-radius: 6px;
      background-color: #f9f9f9;
    }
    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 20px;
    }
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    button i {
      margin-right: 8px;
    }
    .btn-primary {
      background-color: #3498db;
      color: white;
    }
    .btn-primary:hover {
      background-color: #2980b9;
    }
    .btn-success {
      background-color: #2ecc71;
      color: white;
    }
    .btn-success:hover {
      background-color: #27ae60;
    }
    .btn-danger {
      background-color: #e74c3c;
      color: white;
    }
    .btn-danger:hover {
      background-color: #c0392b;
    }
    .btn-secondary {
      background-color: #95a5a6;
      color: white;
    }
    .btn-secondary:hover {
      background-color: #7f8c8d;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 12px 15px;
      border: 1px solid #e0e0e0;
      text-align: left;
      vertical-align: middle;
    }
    th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: #2c3e50;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    tr:hover {
      background-color: #f1f7fd;
    }
    .item-image {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #imagePreview {
      max-width: 250px;
      max-height: 250px;
      margin-top: 10px;
      border-radius: 8px;
      display: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .search-container {
      margin-bottom: 20px;
      position: relative;
    }
    #searchInput {
      padding: 12px 15px 12px 40px;
      border: 1px solid #ddd;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>');
      background-repeat: no-repeat;
      background-position: 12px center;
    }
    .category-tabs {
      display: flex;
      overflow-x: auto;
      margin-bottom: 20px;
      gap: 5px;
      padding-bottom: 5px;
    }
    .category-tab {
      padding: 8px 16px;
      cursor: pointer;
      background-color: #ecf0f1;
      border: none;
      border-radius: 20px;
      white-space: nowrap;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
    }
    .category-tab.active {
      background-color: #3498db;
      color: white;
    }
    .upload-section {
      margin-top: 25px;
      padding: 20px;
      background-color: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    .upload-section h3 {
      margin-top: 0;
      color: #2c3e50;
    }
    .progress-container {
      margin-top: 15px;
      display: none;
    }
    progress {
      width: 100%;
      height: 8px;
      border-radius: 4px;
    }
    .status-message {
      margin-top: 8px;
      font-size: 14px;
      color: #7f8c8d;
      font-style: italic;
    }
    .results-container {
      margin-top: 20px;
      border: 1px solid #e0e0e0;
      padding: 15px;
      border-radius: 8px;
      background-color: #f8f9fa;
      display: none;
    }
    #loadingOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .loading-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      max-width: 400px;
    }
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .alert {
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: none;
    }
    .alert-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .alert-danger {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .template-download {
      margin-top: 15px;
      text-align: center;
    }
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }
      .form-container, .menu-container {
        min-width: 100%;
      }
      .button-group {
        flex-direction: column;
      }
      button {
        width: 100%;
      }
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

  <h1><i class="fas fa-utensils"></i> Menu Management System</h1>

  <div class="container">
    <div class="form-container">
      <h2><i class="fas fa-edit"></i> Add/Edit Menu Item</h2>
      
      <div id="successAlert" class="alert alert-success"></div>
      <div id="errorAlert" class="alert alert-danger"></div>
      
      <div class="form-group">
        <label for="productCode"><i class="fas fa-barcode"></i> Item Code:</label>
        <input type="text" id="productCode" placeholder="Enter item code" />
      </div>
      
      <div class="form-group">
        <label for="productName"><i class="fas fa-font"></i> Item Name (Chinese):</label>
        <input type="text" id="productName" placeholder="Enter Chinese name" />
      </div>
      
      <div class="form-group">
        <label for="productNameEn"><i class="fas fa-language"></i> Item Name (English):</label>
        <input type="text" id="productNameEn" placeholder="Enter English name" />
      </div>

      <div class="form-group">
        <label for="productPrice"><i class="fas fa-tag"></i> Price (RM):</label>
        <input type="number" id="productPrice" step="0.01" min="0" placeholder="0.00" />
      </div>

      <div class="form-group">
        <label for="productCategory"><i class="fas fa-list"></i> Category:</label>
        <select id="productCategory">
          <option value="">-- Select Category --</option>
          <option value="Rice">Rice 饭类</option>
          <option value="Noodles">Noodles 面类</option>
          <option value="Soup">Soup 汤类</option>
          <option value="Tom Yam">Tom Yam 东炎</option>
          <option value="Snacks">Snacks 小食</option>
          <option value="Milk Tea">Milk Tea 奶茶</option>
          <option value="Green Tea">Green Tea 绿茶</option>
          <option value="Fruit Juice">Fruit Juice 水果汁</option>
          <option value="Add Ons">Add Ons 另加</option>
        </select>
      </div>

      <div class="form-group">
        <label for="productDescription"><i class="fas fa-sticky-note"></i> Description/Special Notes:</label>
        <textarea id="productDescription" rows="3" placeholder="Enter description"></textarea>
      </div>

      <div class="form-group">
        <label for="productImage"><i class="fas fa-image"></i> Image (max 2MB):</label>
        <input type="file" id="productImage" accept="image/*" />
        <img id="imagePreview" alt="Image preview" />
      </div>

      <div class="button-group">
        <button onclick="addOrUpdateItem()" id="addUpdateBtn" class="btn-primary">
          <i class="fas fa-plus"></i> Add Item
        </button>
        <button onclick="clearForm()" class="btn-secondary">
          <i class="fas fa-eraser"></i> Clear Form
        </button>
      </div>

      <!-- Excel Upload Section -->
      <div class="upload-section">
        <h3><i class="fas fa-file-excel"></i> Excel Menu Import</h3>
        
        <div class="template-download">
          <a href="#" onclick="downloadTemplate()" class="btn-secondary">
            <i class="fas fa-download"></i> Download Template
          </a>
        </div>
        
        <input type="file" id="excelUpload" accept=".xlsx, .xls, .csv" />
        <div class="progress-container" id="excelProgress">
          <progress value="0" max="100"></progress>
          <div class="status-message" id="excelStatus">Ready to upload</div>
        </div>
        <button onclick="processExcel()" id="processExcelBtn" class="btn-success" style="margin-top: 10px;">
          <i class="fas fa-upload"></i> Import Excel
        </button>
        
        <div class="results-container" id="excelResults">
          <h4><i class="fas fa-list-check"></i> Import Summary:</h4>
          <div id="excelResultsContent"></div>
          <button onclick="confirmExcelImport()" class="btn-primary" style="margin-top: 10px;">
            <i class="fas fa-check"></i> Confirm Import
          </button>
        </div>
      </div>
    </div>

    <div class="menu-container">
      <h2><i class="fas fa-list-ul"></i> Current Menu</h2>
      
      <div class="category-tabs">
        <button class="category-tab active" onclick="filterMenu('all', event)">
          <i class="fas fa-layer-group"></i> All
        </button>
        <button class="category-tab" onclick="filterMenu('Rice', event)">
          <i class="fas fa-utensils"></i> Rice
        </button>
        <button class="category-tab" onclick="filterMenu('Noodles', event)">
          <i class="fas fa-utensils"></i> Noodles
        </button>
        <button class="category-tab" onclick="filterMenu('Soup', event)">
          <i class="fas fa-utensils"></i> Soup
        </button>
        <button class="category-tab" onclick="filterMenu('Tom Yam', event)">
          <i class="fas fa-pepper-hot"></i> Tom Yam
        </button>
        <button class="category-tab" onclick="filterMenu('Snacks', event)">
          <i class="fas fa-cookie"></i> Snacks
        </button>
        <button class="category-tab" onclick="filterMenu('Milk Tea', event)">
          <i class="fas fa-coffee"></i> Milk Tea
        </button>
        <button class="category-tab" onclick="filterMenu('Green Tea', event)">
          <i class="fas fa-mug-hot"></i> Green Tea
        </button>
        <button class="category-tab" onclick="filterMenu('Fruit Juice', event)">
          <i class="fas fa-glass-water"></i> Fruit Juice
        </button>
        <button class="category-tab" onclick="filterMenu('Add Ons', event)">
          <i class="fas fa-plus-circle"></i> Add Ons
        </button>
      </div>
      
      <div class="search-container">
        <input type="text" id="searchInput" placeholder="Search menu items..." oninput="searchMenu()" />
      </div>
      
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th>Code</th>
              <th>Image</th>
              <th>Name (CN)</th>
              <th>Name (EN)</th>
              <th>Price</th>
              <th>Category</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="menuTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <h3 id="loadingText">Processing, please wait...</h3>
      <p id="loadingSubtext"></p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    // Global variables
    let editIndex = -1;
    let currentMenu = [];
    let currentCategoryFilter = 'all';
    let currentSearchTerm = '';
    let excelImportData = [];
    let lastBackupTime = 0;

    // Sample initial menu data
    const sampleMenuData = [
      { code: '509', name: '椰浆饭 + 蛋', nameEn: 'Nasi Lemak Egg', price: 4.00, category: 'Rice' },
      { code: '510', name: '椰浆饭香肠 + 蛋', nameEn: 'Nasi Lemak HotDog Egg', price: 5.00, category: 'Rice' },
      { code: '511', name: '椰浆饭鱼柳 + 蛋', nameEn: 'Nasi Lemak FishWillow Egg', price: 7.00, category: 'Rice' },
      { code: '512', name: '椰浆饭鸡腿 + 蛋', nameEn: 'Nasi Lemak Chicken Leg Egg', price: 8.50, category: 'Rice' },
      { code: '411', name: '清汤面粉糕', nameEn: 'Soup Mee Hun Kulin', price: 8.00, category: 'Noodles' },
      { code: '412', name: '东炎面粉糕', nameEn: 'Tom Yam Mee Hun Kulin', price: 8.00, category: 'Noodles' },
      { code: '417', name: '干捞面粉糕', nameEn: 'Dry Mee Hun Kulin', price: 8.00, category: 'Noodles' },
      { code: '611', name: '薯条（小Small）', nameEn: 'French Fries Small', price: 7.00, category: 'Snacks' },
      { code: '612', name: '薯条（大Big）', nameEn: 'French Fries Big', price: 10.00, category: 'Snacks' },
      { code: '101', name: '原味奶茶', nameEn: 'Original Milk Tea', price: 9.00, category: 'Milk Tea', description: 'Cold RM9.00, Hot RM5.00' },
      { code: 'B01', name: '蛋', nameEn: 'Egg', price: 1.50, category: 'Add Ons' }
    ];

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      // Setup image preview
      document.getElementById("productImage").addEventListener("change", function() {
        const file = this.files[0];
        if (!file) return;
        
        if (file.size > 2 * 1024 * 1024) {
          showAlert("Image size should be less than 2MB", "error");
          this.value = "";
          return;
        }
        
        if (!file.type.match('image.*')) {
          showAlert("Please select an image file", "error");
          this.value = "";
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          const preview = document.getElementById("imagePreview");
          preview.src = e.target.result;
          preview.style.display = "block";
        };
        reader.onerror = function() {
          showAlert("Error reading image file", "error");
        };
        reader.readAsDataURL(file);
      });

      // Listen for menu updates from other tabs
      window.addEventListener('menuUpdated', loadMenu);
      window.addEventListener('storage', function(event) {
        if (event.key === 'menu_updated') {
          loadMenu();
        }
      });

      // Load menu initially
      loadMenu();
      
      // Set up periodic backups (every 5 minutes)
      setInterval(backupMenu, 300000);
    });

    // ========== CORE FUNCTIONS ==========

    // Load menu from localStorage or initialize with sample data
    function loadMenu() {
      showLoading("Loading menu...");
      try {
        const savedMenu = localStorage.getItem("menu");
        if (savedMenu) {
          currentMenu = JSON.parse(savedMenu);
        } else {
          currentMenu = sampleMenuData;
          localStorage.setItem("menu", JSON.stringify(currentMenu));
        }
        renderMenuTable();
      } catch (error) {
        console.error("Error loading menu:", error);
        showAlert("Error loading menu data. Trying backup...", "error");
        try {
          // Try to load from backup if main data is corrupted
          const backupKeys = Object.keys(localStorage).filter(key => key.startsWith("menu_backup_"));
          if (backupKeys.length > 0) {
            const latestBackupKey = backupKeys.sort().reverse()[0];
            currentMenu = JSON.parse(localStorage.getItem(latestBackupKey));
            localStorage.setItem("menu", JSON.stringify(currentMenu));
            showAlert("Loaded from backup successfully!", "success");
          }
        } catch (backupError) {
          console.error("Backup load failed:", backupError);
          currentMenu = sampleMenuData;
          localStorage.setItem("menu", JSON.stringify(currentMenu));
          showAlert("Reset to default menu due to data corruption.", "error");
        }
      } finally {
        hideLoading();
      }
    }

    // Render menu table with current filters
    function renderMenuTable() {
      const tableBody = document.getElementById("menuTableBody");
      tableBody.innerHTML = "";

      let filteredMenu = currentMenu.filter(item => {
        const matchesCategory = currentCategoryFilter === 'all' || item.category === currentCategoryFilter;
        
        if (currentSearchTerm === '') {
          return matchesCategory;
        }
        
        const searchTerm = currentSearchTerm.toLowerCase();
        const matchesSearch = 
          (item.code && item.code.toLowerCase().includes(searchTerm)) || 
          (item.name && item.name.toLowerCase().includes(searchTerm)) || 
          (item.nameEn && item.nameEn.toLowerCase().includes(searchTerm)) ||
          (item.description && item.description.toLowerCase().includes(searchTerm));
        
        return matchesCategory && matchesSearch;
      });

      if (filteredMenu.length === 0) {
        const row = document.createElement("tr");
        row.innerHTML = `<td colspan="7" style="text-align: center; padding: 30px; color: #7f8c8d;">No menu items found</td>`;
        tableBody.appendChild(row);
        return;
      }

      filteredMenu.forEach((item) => {
        const row = document.createElement("tr");

        row.innerHTML = `
          <td>${item.code}</td>
          <td>${item.image ? `<img src="${item.image}" alt="${item.name}" class="item-image" />` : '-'}</td>
          <td>${item.name}</td>
          <td>${item.nameEn || '-'}</td>
          <td>RM${item.price.toFixed(2)}</td>
          <td>${item.category}</td>
          <td>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
  <button class="action-btn btn-primary" onclick="editItem('${item.code}')" aria-label="Edit ${item.name}">
    <i class="fas fa-edit"></i> Edit
  </button>
  <button class="delete-btn btn-danger" onclick="deleteItem('${item.code}')" aria-label="Delete ${item.name}">
    <i class="fas fa-trash"></i> Delete
  </button>
</div>

            </button>
          </td>
        `;
        tableBody.appendChild(row);
      });

      document.getElementById('addUpdateBtn').innerHTML = editIndex >= 0 ? 
        '<i class="fas fa-save"></i> Update Item' : '<i class="fas fa-plus"></i> Add Item';
    }

    // Filter menu by category
    function filterMenu(category, event) {
      currentCategoryFilter = category;
      const tabs = document.querySelectorAll('.category-tab');
      tabs.forEach(tab => tab.classList.remove('active'));
      if (event && event.currentTarget) event.currentTarget.classList.add('active');
      renderMenuTable();
    }

    // Search menu items
    function searchMenu() {
      currentSearchTerm = document.getElementById("searchInput").value.trim().toLowerCase();
      renderMenuTable();
    }

    // ========== ITEM MANAGEMENT FUNCTIONS ==========

    // Validate form inputs
    function validateForm() {
      const code = document.getElementById("productCode").value.trim();
      const name = document.getElementById("productName").value.trim();
      const price = document.getElementById("productPrice").value;
      const category = document.getElementById("productCategory").value;
      
      if (!code) {
        showAlert("Item code is required", "error");
        document.getElementById("productCode").focus();
        return false;
      }
      if (!name) {
        showAlert("Chinese name is required", "error");
        document.getElementById("productName").focus();
        return false;
      }
      if (!price || isNaN(price) || parseFloat(price) <= 0) {
        showAlert("Please enter a valid price", "error");
        document.getElementById("productPrice").focus();
        return false;
      }
      if (!category) {
        showAlert("Please select a category", "error");
        document.getElementById("productCategory").focus();
        return false;
      }
      return true;
    }

    // Edit item
    function editItem(code) {
      const index = currentMenu.findIndex(item => item.code === code);
      if (index === -1) return;
      
      const item = currentMenu[index];
      editIndex = index;

      document.getElementById("productCode").value = item.code;
      document.getElementById("productName").value = item.name;
      document.getElementById("productNameEn").value = item.nameEn || '';
      document.getElementById("productPrice").value = item.price;
      document.getElementById("productCategory").value = item.category;
      document.getElementById("productDescription").value = item.description || "";
      document.getElementById("productImage").value = "";
      
      const imagePreview = document.getElementById("imagePreview");
      if (item.image) {
        imagePreview.src = item.image;
        imagePreview.style.display = "block";
      } else {
        imagePreview.style.display = "none";
      }
      
      document.getElementById('addUpdateBtn').innerHTML = '<i class="fas fa-save"></i> Update Item';
      document.getElementById("productCode").focus();
    }

    // Delete item
    function deleteItem(code) {
      if (!confirm('Are you sure you want to delete this item?')) return;

      showLoading("Deleting item...");
      try {
        const index = currentMenu.findIndex(item => item.code === code);
        if (index === -1) return;
        
        currentMenu.splice(index, 1);
        localStorage.setItem("menu", JSON.stringify(currentMenu));
        backupMenu();
        broadcastMenuUpdate();
        
        if (editIndex === index) {
          clearForm();
        } else if (editIndex > index) {
          editIndex--;
        }
        
        renderMenuTable();
        showAlert("Item deleted successfully", "success");
      } finally {
        hideLoading();
      }
    }

    // Clear form
    function clearForm() {
      document.getElementById("productCode").value = "";
      document.getElementById("productName").value = "";
      document.getElementById("productNameEn").value = "";
      document.getElementById("productPrice").value = "";
      document.getElementById("productCategory").value = "";
      document.getElementById("productDescription").value = "";
      document.getElementById("productImage").value = "";
      document.getElementById("imagePreview").style.display = "none";
      editIndex = -1;
      document.getElementById('addUpdateBtn').innerHTML = '<i class="fas fa-plus"></i> Add Item';
      document.getElementById("productCode").focus();
    }

    // Add or update item
    function addOrUpdateItem() {
      if (!validateForm()) return;

      showLoading(editIndex >= 0 ? "Updating item..." : "Adding item...");
      try {
        const code = document.getElementById("productCode").value.trim();
        const name = document.getElementById("productName").value.trim();
        const nameEn = document.getElementById("productNameEn").value.trim();
        const price = parseFloat(document.getElementById("productPrice").value);
        const category = document.getElementById("productCategory").value;
        const description = document.getElementById("productDescription").value.trim();
        const imageInput = document.getElementById("productImage");

        // Check for duplicate code when adding new item
        if (editIndex === -1 && currentMenu.some(item => item.code === code)) {
          showAlert(`Item with code ${code} already exists. Please use a unique code.`, "error");
          document.getElementById("productCode").focus();
          return;
        }

        function saveItem(imageData) {
          const item = { 
            code,
            name, 
            nameEn: nameEn || null,
            price, 
            category, 
            description: description || null,
            image: imageData || (editIndex >= 0 ? currentMenu[editIndex].image : null)
          };

          if (editIndex >= 0) {
            currentMenu[editIndex] = item;
            showAlert("Item updated successfully", "success");
          } else {
            currentMenu.push(item);
            showAlert("Item added successfully", "success");
          }

          localStorage.setItem("menu", JSON.stringify(currentMenu));
          backupMenu();
          broadcastMenuUpdate();
          clearForm();
          renderMenuTable();
        }

        if (imageInput.files.length > 0) {
          const file = imageInput.files[0];
          if (file.size > 2 * 1024 * 1024) {
            showAlert("Image size should be less than 2MB", "error");
            return;
          }
          
          const reader = new FileReader();
          reader.onload = function() {
            saveItem(reader.result);
          };
          reader.onerror = function() {
            showAlert("Error reading image file", "error");
            hideLoading();
          };
          reader.readAsDataURL(file);
        } else {
          saveItem(null);
        }
      } finally {
        hideLoading();
      }
    }

    // ========== EXCEL IMPORT FUNCTIONS ==========

    // Download Excel template
    function downloadTemplate() {
      showLoading("Preparing template...");
      
      // Create sample data for template
      const templateData = [
        {
          "Item Code": "101",
          "Name (CN)": "原味奶茶",
          "Name (EN)": "Original Milk Tea",
          "Price": 9.00,
          "Category": "Milk Tea",
          "Description": "Cold RM9.00, Hot RM5.00"
        },
        {
          "Item Code": "411",
          "Name (CN)": "清汤面粉糕",
          "Name (EN)": "Soup Mee Hun Kulin",
          "Price": 8.00,
          "Category": "Noodles",
          "Description": ""
        }
      ];
      
      try {
        // Create workbook
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(templateData);
        XLSX.utils.book_append_sheet(wb, ws, "Menu Items");
        
        // Generate file and download
        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        const blob = new Blob([wbout], { type: 'application/octet-stream' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = 'Menu_Template.xlsx';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showAlert("Template downloaded successfully", "success");
      } catch (error) {
        console.error("Error generating template:", error);
        showAlert("Error generating template", "error");
      } finally {
        hideLoading();
      }
    }

    // Process Excel file
    function processExcel() {
      const fileInput = document.getElementById('excelUpload');
      const progressContainer = document.getElementById('excelProgress');
      const statusMessage = document.getElementById('excelStatus');
      const processBtn = document.getElementById('processExcelBtn');
      const resultsDiv = document.getElementById('excelResults');
      
      if (!fileInput.files || fileInput.files.length === 0) {
        showAlert('Please select an Excel file first.', "error");
        return;
      }

      const file = fileInput.files[0];
      
      // Show progress
      progressContainer.style.display = 'block';
      processBtn.disabled = true;
      statusMessage.textContent = 'Processing Excel file...';
      showLoading("Processing Excel file...");
      
      // Use SheetJS library to read Excel
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          
          // Get first sheet
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet);
          
          // Process the data
          processExcelData(jsonData);
          
          statusMessage.textContent = 'Excel processed successfully!';
          resultsDiv.style.display = 'block';
        } catch (error) {
          console.error("Error processing Excel:", error);
          statusMessage.textContent = 'Error processing Excel file';
          showAlert('Error processing Excel file. Please check the format.', "error");
        } finally {
          processBtn.disabled = false;
          hideLoading();
        }
      };
      reader.onerror = function() {
        showAlert("Error reading Excel file", "error");
        processBtn.disabled = false;
        hideLoading();
      };
      reader.readAsArrayBuffer(file);
    }

    // Process Excel data
    function processExcelData(data) {
      // Convert Excel data to our menu format
      excelImportData = data.map(row => {
        // Try different column name variations
        const code = row['Item Code'] || row['Code'] || row['item_code'] || '';
        const name = row['Name (CN)'] || row['Name'] || row['name_cn'] || '';
        const nameEn = row['Name (EN)'] || row['English Name'] || row['name_en'] || '';
        const price = parseFloat(row['Price'] || row['Price (RM)'] || row['price'] || 0);
        const category = row['Category'] || row['category'] || '';
        const description = row['Description'] || row['Notes'] || row['description'] || '';
        
        return {
          code: code.toString().trim(),
          name: name.toString().trim(),
          nameEn: nameEn.toString().trim(),
          price: isNaN(price) ? 0 : price,
          category: category.toString().trim(),
          description: description.toString().trim(),
          valid: code && name && !isNaN(price) && price > 0 && category
        };
      });

      // Count valid and invalid items
      const validItems = excelImportData.filter(item => item.valid);
      const invalidItems = excelImportData.filter(item => !item.valid);
      
      // Display the results
      const resultsContent = document.getElementById('excelResultsContent');
      resultsContent.innerHTML = `
        <p><strong>${validItems.length}</strong> valid items found</p>
        ${invalidItems.length > 0 ? `
          <p><strong>${invalidItems.length}</strong> invalid items (will be skipped):</p>
          <ul style="color: #e74c3c; max-height: 150px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 4px;">
            ${invalidItems.map(item => `
              <li>
                ${item.code || 'No code'} - ${item.name || 'No name'} - 
                ${isNaN(item.price) ? 'Invalid price' : 'RM' + item.price.toFixed(2)} - 
                ${item.category || 'No category'}
              </li>
            `).join('')}
          </ul>
        ` : ''}
      `;
    }

    // Confirm Excel import
    function confirmExcelImport() {
      if (!excelImportData || excelImportData.length === 0) {
        showAlert("No data to import", "error");
        return;
      }

      const validItems = excelImportData.filter(item => item.valid);
      if (validItems.length === 0) {
        showAlert("No valid items to import", "error");
        return;
      }

      if (!confirm(`Import ${validItems.length} menu items? This will overwrite existing items with the same codes.`)) {
        return;
      }

      showLoading(`Importing ${validItems.length} items...`);
      
      try {
        // Create a copy of current menu
        let newMenu = [...currentMenu];
        
        // Add/update items from Excel
        validItems.forEach(importItem => {
          const existingIndex = newMenu.findIndex(item => item.code === importItem.code);
          
          if (existingIndex >= 0) {
            // Update existing item
            newMenu[existingIndex] = {
              code: importItem.code,
              name: importItem.name,
              nameEn: importItem.nameEn || null,
              price: importItem.price,
              category: importItem.category,
              description: importItem.description || null,
              image: newMenu[existingIndex].image || null
            };
          } else {
            // Add new item
            newMenu.push({
              code: importItem.code,
              name: importItem.name,
              nameEn: importItem.nameEn || null,
              price: importItem.price,
              category: importItem.category,
              description: importItem.description || null,
              image: null
            });
          }
        });

        // Update menu
        currentMenu = newMenu;
        localStorage.setItem("menu", JSON.stringify(currentMenu));
        backupMenu();
        broadcastMenuUpdate();
        renderMenuTable();
        
        // Reset import UI
        document.getElementById('excelResults').style.display = 'none';
        document.getElementById('excelUpload').value = '';
        document.getElementById('excelProgress').style.display = 'none';
        
        showAlert(`Successfully imported ${validItems.length} menu items!`, "success");
      } catch (error) {
        console.error("Error importing data:", error);
        showAlert("Error importing menu items", "error");
      } finally {
        hideLoading();
      }
    }

    // ========== UTILITY FUNCTIONS ==========

    // Show alert message
    function showAlert(message, type) {
      const successAlert = document.getElementById('successAlert');
      const errorAlert = document.getElementById('errorAlert');
      
      if (type === "success") {
        successAlert.textContent = message;
        successAlert.style.display = 'block';
        errorAlert.style.display = 'none';
      } else {
        errorAlert.textContent = message;
        errorAlert.style.display = 'block';
        successAlert.style.display = 'none';
      }
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        successAlert.style.display = 'none';
        errorAlert.style.display = 'none';
      }, 5000);
    }

    // Broadcast menu update to other tabs
    function broadcastMenuUpdate() {
      const menuUpdateEvent = new Event('menuUpdated');
      window.dispatchEvent(menuUpdateEvent);
      localStorage.setItem('menu_updated', Date.now().toString());
    }

    // Create a backup of the menu
    function backupMenu() {
      const now = Date.now();
      // Only backup every 5 minutes to avoid too many backups
      if (now - lastBackupTime > 300000) {
        localStorage.setItem("menu_backup_" + new Date().toISOString(), JSON.stringify(currentMenu));
        lastBackupTime = now;
      }
    }

    // Show loading overlay
    function showLoading(message = "Loading...", submessage = "") {
      document.getElementById('loadingText').textContent = message;
      document.getElementById('loadingSubtext').textContent = submessage;
      document.getElementById('loadingOverlay').style.display = 'flex';
    }

    // Hide loading overlay
    function hideLoading() {
      document.getElementById('loadingOverlay').style.display = 'none';
    }

  </script>
</body>
</html>